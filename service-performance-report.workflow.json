{
  "id": "d3f98cdf-e188-449b-ad02-d00deab782cc",
  "title": "Service Performance Report",
  "description": "This Workflow generates Service Performance reports and emails to the specified addresses.",
  "actor": "1f41bd32-2ce1-408d-b6e2-efb6a36f870d",
  "owner": "1f41bd32-2ce1-408d-b6e2-efb6a36f870d",
  "ownerType": "USER",
  "isPrivate": true,
  "schemaVersion": 3,
  "trigger": {},
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 10,
  "guide": "# Service Performance Report\nGet a list of your top Services. This Workflow queries Grail and provides data to Dynatrace Assist to get recommendations. These recommendations are then sent to email(s) of your choice.\n\n# Setup\n1. Change emails (`to`, `cc`, `bcc`) to be an array of strings.\n2. Test with a manual Run, by click the `Run` button.\n3. If everything works as expected, change the [Trigger](?trigger=) to a schedule, e.g. Weekly, Daily, etc.\n\n# More advanced interactions\nConsider using our MCP server, [local](https://github.com/dynatrace-oss/dynatrace-mcp) or [remote](https://docs.dynatrace.com/docs/discover-dynatrace/platform/davis-ai/dynatrace-mcp ).",
  "tasks": {
    "tenant": {
      "name": "tenant",
      "input": {
        "query": "fetch dt.entity.environment\n| fields URL=concat(\"[Open in Dynatrace](http://\",dt.system.environment,\".apps.dynatrace.com/ui/apps/dynatrace.services/explorer?perspective=performance&sort=healthIndicators%3Adescending)\")\n| limit 1"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": -1,
        "y": 1
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "service_performance": {
      "name": "service_performance",
      "input": {
        "query": "timeseries {p50 = median(dt.service.request.response_time),\n           p90 = percentile(dt.service.request.response_time, 90),\n           p99 = percentile(dt.service.request.response_time, 99),\n           requests = sum(dt.service.request.count), \n           errors = sum(dt.service.request.failure_count)},\n           by:{dt.entity.service}\n| fieldsAdd p50 = round(arrayAvg(p50)/1000, decimals: 2),\n            p90 = round(arrayAvg(p90)/1000, decimals: 2),\n            p99 = round(arrayAvg(p99)/1000, decimals: 2),\n            Requests = arraySum(requests), \n            Failures = arraySum(errors)\n| fieldsAdd FailureRate = concat(round((Failures/Requests) *100, decimals: 2),\"%\")\n| fieldsAdd Service = entityName(dt.entity.service)\n| filterOut isNull(Service)\n| fields Service,\n         Requests,\n         `p50(ms)` = p50,\n         `p90(ms)` = p90,\n         `p99(ms)` = p99,\n         FailureRate,\n         Failures\n| sort `p50(ms)` desc\n| limit 25"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": 1,
        "y": 1
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {}
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "email_service_report": {
      "name": "email_service_report",
      "input": {
        "cc": [],
        "to": [],
        "bcc": [],
        "content": "{{result(\"service_performance_report_prompt\").text}}\n# ___________________________________\n{% for type in result(\"tenant\").records %}\n    {% for key, value in type.items() %} {{value | replace('|', '\\\\|') | replace('\\n', ' ') | replace('\\r', '') | replace('\\t', ' ')}} {% endfor %}  \n{% endfor %}\n# ___________________________________\n",
        "subject": "Service Performance Report"
      },
      "action": "dynatrace.email:send-email",
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "service_performance_report_prompt": "OK"
        }
      },
      "description": "Send email",
      "predecessors": [
        "service_performance_report_prompt"
      ]
    },
    "service_performance_report_prompt": {
      "name": "service_performance_report_prompt",
      "input": {
        "config": "disabled",
        "prompt": "Provide a markdown report for the following use case:\n## Service Performance Report\n",
        "autoTrim": true,
        "instruction": "Instead of bulleted list, format Services in a table. Provide a Summary, Observations, Recommendations and Next Steps.",
        "supplementary": "Use this analysis for the past 24 hours:\n{{result(\"service_performance\")[\"records\"]}}"
      },
      "retry": {
        "count": 2,
        "delay": 30,
        "failedLoopIterationsOnly": true
      },
      "action": "dynatrace.davis.copilot.workflow.actions:davis-copilot",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "tenant": "OK",
          "service_performance": "OK"
        }
      },
      "description": "Prompt the Dynatrace Intelligence generative AI",
      "predecessors": [
        "tenant",
        "service_performance"
      ]
    }
  }
}