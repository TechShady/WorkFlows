{
  "title": "Core Web Vitals Page Report",
  "description": "This Workflow generates a core web vitals page report and emails to the specified addresses.",
  "ownerType": "USER",
  "isPrivate": true,
  "schemaVersion": 3,
  "trigger": {},
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 10,
  "guide": "# Core Web Vitals Report\nGet a top 25 list of pages core web vitals with observations and recommendations. This Workflow queries Grail and provides data to Dynatrace Assist to get recommendations. These recommendations are then sent to email(s) of your choice.\n\n# Setup\n1. Change emails (`to`, `cc`, `bcc`) to be an array of strings.\n2. Test with a manual Run, by click the `Run` button.\n3. If everything works as expected, change the [Trigger](?trigger=) to a schedule, e.g. Weekly, Daily, etc.\n\n# More advanced interactions\nConsider using our MCP server, [local](https://github.com/dynatrace-oss/dynatrace-mcp) or [remote](https://docs.dynatrace.com/docs/discover-dynatrace/platform/davis-ai/dynatrace-mcp ).",
  "tasks": {
    "cwv_query": {
      "name": "cwv_query",
      "input": {
        "query": "fetch user.events, from: @d-1d, to: @d\n| filter characteristics.has_page_summary or characteristics.has_w3c_navigation_timings\n| filter isNotNull(page.name)\n| summarize {\n    wlcp = if(isNull(percentile(web_vitals.largest_contentful_paint, 75)), 0, else:percentile(web_vitals.largest_contentful_paint, 75)), \n    wcls = if(isNull(percentile(web_vitals.cumulative_layout_shift, 75)), 0, else:percentile(web_vitals.cumulative_layout_shift, 75)), \n    winp = if(isNull(percentile(web_vitals.interaction_to_next_paint, 75)), 0, else:percentile(web_vitals.interaction_to_next_paint, 75)), \n    Count = countIf(characteristics.has_w3c_navigation_timings)\n  }, by: { page.name, dt.rum.application.entity }\n| fieldsAdd dt.entity.application = dt.rum.application.entity\n| fieldsAdd Application = entityName(dt.entity.application)\n| fieldsRemove dt.entity.application\n| fields App=Application, Page = page.name, `Count` = Count, CWVScore = if(((wcls >= .1) or (toDouble(wlcp) >= 2500000000) or (toDouble(winp) >= 200000000)), \"\u274cFail\", else: \"\u2705Pass\"), `LCP(ms)` = wlcp/1000000, `INP(ms)` = winp/1000000, `CLS(#)` = round(wcls,decimals:4)\n| sort Count desc\n| limit 25"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": 1,
        "y": 1
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {}
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "tenant_query": {
      "name": "tenant_query",
      "input": {
        "query": "fetch dt.entity.environment\n| fields URL=concat(\"[Open in Dynatrace](http://\",dt.system.environment,\".apps.dynatrace.com/ui/apps/dynatrace.experience.vitals/frontends)\")\n| limit 1"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": -1,
        "y": 1
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "email_cwv_report": {
      "name": "email_cwv_report",
      "input": {
        "cc": [],
        "to": [],
        "bcc": [],
        "content": "{{result(\"cwv_query_report_prompt\").text}}\n# ___________________________________\n{% for type in result(\"tenant_query\").records %}\n    {% for key, value in type.items() %} {{value | replace('|', '\\\\|') | replace('\\n', ' ') | replace('\\r', '') | replace('\\t', ' ')}} {% endfor %}  \n{% endfor %}\n# ___________________________________\n",
        "subject": "Core Web Vitals Report"
      },
      "action": "dynatrace.email:send-email",
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "cwv_query_report_prompt": "OK"
        }
      },
      "description": "Send email",
      "predecessors": [
        "cwv_query_report_prompt"
      ]
    },
    "cwv_query_report_prompt": {
      "name": "cwv_query_report_prompt",
      "input": {
        "config": "dynatrace",
        "prompt": "Provide a report for the following use case:\nCore Web Vitals Report\n",
        "autoTrim": true,
        "instruction": " Provide Key Metrics Definition and Overall Pass/Fail summary. Format DQL query results, observations, recommendations and next steps in a table. All in this order for all 25 pages.",
        "supplementary": "Use this analysis of Page Views for the past 24 hours:\n{{result(\"cwv_query\")[\"records\"]}}"
      },
      "retry": {
        "count": 2,
        "delay": 30,
        "failedLoopIterationsOnly": true
      },
      "action": "dynatrace.davis.copilot.workflow.actions:davis-copilot",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "cwv_query": "OK",
          "tenant_query": "OK"
        }
      },
      "description": "Prompt the Dynatrace Intelligence generative AI",
      "predecessors": [
        "cwv_query",
        "tenant_query"
      ]
    }
  }
}