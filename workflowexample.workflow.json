{
  "title": "WorkflowExample",
  "description": "This Workflow generates Service Performance reports and emails to the specified addresses.",
  "ownerType": "USER",
  "isPrivate": true,
  "schemaVersion": 3,
  "trigger": {},
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 10,
  "guide": "# Service Performance Report\nGet a list of your top Services. This Workflow queries Grail and provides data to Dynatrace Assist to get recommendations. These recommendations are then sent to email(s) of your choice.\n\n# Setup\n1. Change emails (`to`, `cc`, `bcc`) to be an array of strings.\n2. Test with a manual Run, by click the `Run` button.\n3. If everything works as expected, change the [Trigger](?trigger=) to a schedule, e.g. Weekly, Daily, etc.\n\n# More advanced interactions\nConsider using our MCP server, [local](https://github.com/dynatrace-oss/dynatrace-mcp) or [remote](https://docs.dynatrace.com/docs/discover-dynatrace/platform/davis-ai/dynatrace-mcp ).",
  "tasks": {
    "problems_list": {
      "name": "problems_list",
      "input": {
        "query": "fetch dt.davis.problems\n| filter `dt.davis.is_duplicate` == false\n| sort timestamp desc\n| expand affected_entity_ids\n| lookup [fetch dt.entity.service], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.services\"\n| lookup [fetch dt.entity.process_group_instance], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.pgi\"\n| lookup [fetch dt.entity.application], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.applications\"\n| lookup [fetch dt.entity.mobile_application], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.mobile\"\n| lookup [fetch dt.entity.custom_application], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.customapplication\"\n| lookup [fetch dt.entity.cloud_application], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.cloudapplication\"\n| lookup [fetch dt.entity.synthetic_test], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.synthetictest\"\n| lookup [fetch dt.entity.http_check], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.httpcheck\"\n| lookup [fetch dt.entity.multiprotocol_monitor], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.multiprotocolmonitor\"\n| lookup [fetch dt.entity.kubernetes_cluster], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.kubernetescluster\"\n| lookup [fetch dt.entity.host], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.hosts\"\n| lookup [fetch dt.entity.custom_device], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.customdevices\"\n| lookup [fetch dt.entity.hypervisor], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.hypervisor\"\n| lookup [fetch dt.entity.environment], sourceField:affected_entity_ids, lookupField: id, prefix:\"lookup.affected.entity.environment\"\n| summarize {startTime = takeFirst(event.start),\n            endTime = takeFirst(event.end),\n            problemClosedDuration = takeFirst(resolved_problem_duration),\n            status = takeFirst(event.status),\n            event.name = takeFirst(event.name),\n            severityLevel = takeFirst(event.category),\n            affected = takeFirst(affected_entity_ids),\n            rootCause = takeFirst(root_cause_entity_name),\n            dt.davis.is_duplicate = takeFirst(dt.davis.is_duplicate),\n            affectedServices = collectDistinct(lookup.affected.entity.servicesentity.name),\n            affectedPGI = collectDistinct(lookup.affected.entity.pgientity.name),\n            affectedApplications = collectDistinct(lookup.affected.entity.applicationsentity.name),\n            affectedMobile = collectDistinct(lookup.affected.entity.mobileentity.name),\n            affectedCustomApplication = collectDistinct(lookup.affected.entity.customapplicationentity.name),\n            affectedCloudApplication = collectDistinct(lookup.affected.entity.cloudapplicationentity.name),\n            affectedSyntheticTest = collectDistinct(lookup.affected.entity.synthetictestentity.name),\n            affectedHttpCheck = collectDistinct(lookup.affected.entity.httpcheckentity.name),\n            affectedMultiprotocolMonitor = collectDistinct(lookup.affected.entity.multiprotocolmonitorentity.name),\n            affectedKubernetesCluster = collectDistinct(lookup.affected.entity.kubernetesclusterentity.name),\n            affectedHosts = collectDistinct(lookup.affected.entity.hostsentity.name),\n            affectedCustomDevices = collectDistinct(lookup.affected.entity.customdevicesentity.name),\n            affectedHypervisor = collectDistinct(lookup.affected.entity.hypervisorentity.name),\n            affectedEnvironment = collectDistinct(lookup.affected.entity.environmententity.name),\n            event.id = takeFirst(event.id)}, \n            by:{display_id, event.kind}\n| fieldsAdd currentTime = toTimestamp(now())\n| fieldsAdd Description = concat(display_id,\" - \",event.name)\n| fields Status = status,       \n         Description,\n         Affected = arrayRemoveNulls(arrayConcat(affectedApplications,affectedMobile,affectedCustomApplication,affectedCloudApplication,affectedSyntheticTest,affectedHttpCheck,affectedServices,affectedPGI,affectedKubernetesCluster,affectedHosts,affectedHypervisor,affectedCustomDevices,affectedEnvironment,affectedMultiprotocolMonitor)),\n         RootCause = if(isNotNull(rootCause), rootCause, else:\"\"),\n         StartTime = startTime,\n         EndTime =  if((status == \"ACTIVE\"),\"In Progress\", \n                    else:if((status == \"CLOSED\"),endTime)),   \n         Duration = if((status == \"CLOSED\"),problemClosedDuration,\n                    else:if((status == \"ACTIVE\"), currentTime-startTime)),\n         event.id,\n         event.kind\n| sort StartTime, direction:\"descending\"\n| sort Status, direction:\"ascending\"\n"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": 0,
        "y": 1
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "service_latency": {
      "name": "service_latency",
      "input": {
        "query": "timeseries latency_p50 = percentile(dt.service.request.response_time, 50)"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": -2,
        "y": 1
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "service_summary": {
      "name": "service_summary",
      "input": {
        "query": "timeseries {latency_p50 = median(dt.service.request.response_time),\n           latency_p90 = percentile(dt.service.request.response_time, 90),\n           latency_p99 = percentile(dt.service.request.response_time, 99),\n           requests = sum(dt.service.request.count), \n           errors = sum(dt.service.request.failure_count)},\n           by:{dt.entity.service}\n\n| lookup [ timeseries latency_avg = avg(dt.service.request.response_time),\n           by:{dt.entity.service}],\n            sourceField:dt.entity.service, lookupField:dt.entity.service,\n            prefix: \"latencyAvg.\"\n\n\n\n| lookup [ timeseries http_5xx = sum(dt.service.request.count,default: 0.0),\n           by:{dt.entity.service},\n           filter: (http.response.status_code >= 500 and http.response.status_code <= 599) ],\n            sourceField:dt.entity.service, lookupField:dt.entity.service,\n            prefix: \"http5xx.\"\n\n| lookup [ timeseries http_4xx = sum(dt.service.request.count,default: 0.0),\n           by:{dt.entity.service},\n           filter: (http.response.status_code >= 400 and http.response.status_code <= 499) ],\n            sourceField:dt.entity.service, lookupField:dt.entity.service,\n            prefix: \"http4xx.\"\n\n| lookup [fetch dt.davis.problems, from:now()-7h, to:now()\n         | filter event.status==\"ACTIVE\" and dt.davis.is_duplicate==false// and matchesPhrase(affected_entity_ids, \"SERVICE-\")\n         | expand affected_entity_ids\n         | summarize {Problems = countDistinct(display_id),\n               event.id = takeFirst(event.id),\n               event.kind = takeFirst(event.kind)}, \n               by:{affected_entity_ids}],\n  sourceField:dt.entity.service, lookupField:affected_entity_ids, \n  fields:{Problems, affected_entity_ids,event.id,event.kind}    \n\n| fieldsAdd Latency_Avg = arrayAvg(latencyAvg.latency_avg),\n            Latency_p50 = arrayAvg(latency_p50),\n            Latency_p90 = arrayAvg(latency_p90),\n            Latency_p99 = arrayAvg(latency_p99),\n            Requests = arraySum(requests), \n            Failures = arraySum(errors),\n           `5xx` = arraySum(http5xx.http_5xx),\n           `4xx` = arraySum(http4xx.http_4xx) \n| fieldsAdd FailureRate = (Failures/Requests) *100\n| fieldsAdd Service = entityName(dt.entity.service)\n| fieldsAdd dt.entity.process_group = entityAttr(dt.entity.service, \"runs_on\")\n| fieldsAdd dt.entity.process_group = dt.entity.process_group[dt.entity.process_group]\n| fieldsAdd LogQueryPart2 = \"\"\"\\\")\"\"\" \n| fieldsAdd LogQueryPart2 = encodeUrl(LogQueryPart2)\n| fields Status = if(Problems >= 0 , \"PROBLEM\",  else: \"HEALTHY\"),\n         Service,\n         dt.entity.service,\n         StatusSort = if(Problems > 0, 0, else: 1),\n         Requests,\n         Latency_Avg,\n         Latency_p50,\n         Latency_p90,\n         Latency_p99,\n         FailureRate,\n         Failures,\n        `5xx` = if(isNull(`5xx`), 0, else:`5xx`),\n        `4xx` = if(isNull(`4xx`), 0, else:`4xx`),\n         event.id,\n         event.kind\n| sort StatusSort asc\n| fieldsRemove StatusSort\n| limit 1000"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": 1,
        "y": 1
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "dashboard_prompt": {
      "name": "dashboard_prompt",
      "input": {
        "config": "disabled",
        "prompt": "Provide a report for the following use case:\n## Service Overview Dashboard Analysis Report\nUse this analysis:\n{{result(\"services_current_status\")[\"records\"]}}\n{{result(\"problems_list\")[\"records\"]}}\n{{result(\"service_summary\")[\"records\"]}}\n{{result(\"service_latency\")[\"records\"]}}",
        "autoTrim": true,
        "instruction": "Provide a Summary, Insights, Observations, Recommendations and Next Steps for each query.",
        "supplementary": "Format examples in tables instead of bulleted lists.\nWhere applicable convert units for readability, e.g. 1000000000 bytes is 1 TiB.\nWhere applicable show relative percentages, e.g. 100 used and 1000 allocatable is 10% utilized.\n"
      },
      "retry": {
        "count": 2,
        "delay": 30,
        "failedLoopIterationsOnly": true
      },
      "action": "dynatrace.davis.copilot.workflow.actions:davis-copilot",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "problems_list": "OK",
          "service_latency": "OK",
          "service_summary": "OK",
          "services_current_status": "OK"
        }
      },
      "description": "Prompt the Dynatrace Intelligence generative AI",
      "predecessors": [
        "services_current_status",
        "problems_list",
        "service_summary",
        "service_latency"
      ]
    },
    "email_dashboard_report": {
      "name": "email_dashboard_report",
      "input": {
        "cc": [],
        "to": [],
        "bcc": [],
        "content": "{{result(\"dashboard_prompt\").text}}\n",
        "subject": "Service Overview Dashboard Analysis Report"
      },
      "action": "dynatrace.email:send-email",
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "dashboard_prompt": "OK"
        }
      },
      "description": "Send email",
      "predecessors": [
        "dashboard_prompt"
      ]
    },
    "services_current_status": {
      "name": "services_current_status",
      "input": {
        "query": "fetch dt.entity.service\n| filter serviceType != \"DATABASE_SERVICE\"\n| lookup [\n  fetch dt.davis.problems\n  | filter event.status == \"ACTIVE\"\n  | expand affected_entity_ids\n], sourceField:id, lookupField:affected_entity_ids\n| fieldsAdd affected = if(isNotNull(lookup.affected_entity_ids), \"Problem\", else: \"Healthy\")\n| fields affected, \n         id, \n         entity.name, \n         event.id = lookup.event.id, \n         event.kind = lookup.event.kind\n| sort affected desc\n"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": -1,
        "y": 1
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {}
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    }
  }
}