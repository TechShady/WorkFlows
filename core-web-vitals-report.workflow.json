{
  "title": "Core Web Vitals Report",
  "description": "This workflow generates a core web vitals report and emails to the specified addresses.",
  "ownerType": "USER",
  "isPrivate": true,
  "schemaVersion": 3,
  "trigger": {},
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 10,
  "guide": "# Core Web Vitals Report\nGet a top 25 list of pages core web vitals with observations and recommendations. This agent queries Grail and provides data to Dynatrace Assist to get recommendations. These recommendations are then sent to email(s) of your choice.\n\n# Setup\n1. Change emails (`to`, `cc`, `bcc`) to be an array of strings, e.g.:\n```\n\"to\": [ \"me@email.com\", \"you@email.com\"]\n```\n2. Test with a manual Run, by click the `Run` button.\n3. If everything works as expected, change the [Trigger](?trigger=) to a schedule, e.g. Weekly, Daily, etc.\n\n# More advanced interactions\nConsider using our MCP server, [local](https://github.com/dynatrace-oss/dynatrace-mcp) or [remote](https://docs.dynatrace.com/docs/discover-dynatrace/platform/davis-ai/dynatrace-mcp ).",
  "tasks": {
    "cwv": {
      "name": "cwv",
      "input": {
        "query": "fetch user.events, from: @d-1d, to: @d\n| filter characteristics.has_page_summary or characteristics.has_w3c_navigation_timings\n| filter isNotNull(page.name)\n| summarize {\n    wlcp = if(isNull(percentile(web_vitals.largest_contentful_paint, 75)), 0, else:percentile(web_vitals.largest_contentful_paint, 75)), \n    wfid = if(isNull(percentile(web_vitals.first_input_delay, 75)), 0, else:percentile(web_vitals.first_input_delay, 75)), \n    wcls = if(isNull(percentile(web_vitals.cumulative_layout_shift, 75)), 0, else:percentile(web_vitals.cumulative_layout_shift, 75)), \n    winp = if(isNull(percentile(web_vitals.interaction_to_next_paint, 75)), 0, else:percentile(web_vitals.interaction_to_next_paint, 75)), \n    Count = countIf(characteristics.has_w3c_navigation_timings)\n  }, by: { page.name, dt.rum.application.entity }\n| fieldsAdd dt.entity.application = dt.rum.application.entity\n| fieldsAdd Application = entityName(dt.entity.application)\n| fieldsRemove dt.entity.application\n| fields App=Application, Page = page.name, Count, CWVScore = if((wcls >= .1 or wfid/1000000 >= 100 or wlcp/1000000 >= 2500 or winp/1000000 >= 200), \"\u274cFail\", else: \"\u2705Pass\"), `LCP(ms)` = wlcp/1000000, `INP(ms)` = winp/1000000, `FID(ms)` = wfid/1000000, `CLS(#)` = round(wcls,decimals:4)\n| sort Count desc\n| limit 25"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": 0,
        "y": 1
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {}
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "tenant": {
      "name": "tenant",
      "input": {
        "query": "fetch dt.entity.environment\n| fields URL=concat(\"[Open in Dynatrace](http://\",dt.system.environment,\".apps.dynatrace.com/ui/apps/dynatrace.experience.vitals/frontends)\")\n| limit 1"
      },
      "action": "dynatrace.automations:execute-dql-query",
      "position": {
        "x": -1,
        "y": 1
      },
      "description": "Make use of Dynatrace Grail data in your workflow.",
      "predecessors": []
    },
    "email_cwv_report": {
      "name": "email_cwv_report",
      "input": {
        "cc": [],
        "to": [
          "john.kelly@dynatrace.com"
        ],
        "bcc": [],
        "content": "{{result(\"cwv_report_prompt\").text}}\n# ___________________________________\n{% for type in result(\"tenant\").records %}\n    {% for key, value in type.items() %} {{value | replace('|', '\\\\|') | replace('\\n', ' ') | replace('\\r', '') | replace('\\t', ' ')}} {% endfor %}  \n{% endfor %}\n# ___________________________________\n",
        "subject": "Core Web Vitals Report"
      },
      "action": "dynatrace.email:send-email",
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "cwv_report_prompt": "OK"
        }
      },
      "description": "Send email",
      "predecessors": [
        "cwv_report_prompt"
      ]
    },
    "cwv_report_prompt": {
      "name": "cwv_report_prompt",
      "input": {
        "config": "dynatrace",
        "prompt": "Provide a report for the following use case:\nCore Web Vitals Report\n",
        "autoTrim": true,
        "instruction": "Instead of bulleted list, format observations and recommendations in a table and format cwv in another table. ",
        "supplementary": "Use this analysis of Services for the past 30 days:\n{{result(\"cwv\")[\"records\"]}}"
      },
      "retry": {
        "count": 2,
        "delay": 30,
        "failedLoopIterationsOnly": true
      },
      "action": "dynatrace.davis.copilot.workflow.actions:davis-copilot",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "else": "SKIP",
        "custom": "",
        "states": {
          "cwv": "OK",
          "tenant": "OK"
        }
      },
      "description": "Prompt the Dynatrace Intelligence generative AI",
      "predecessors": [
        "tenant",
        "cwv"
      ]
    }
  }
}